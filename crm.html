<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X-BUILT 99 CRM - Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal { display: none; }
    .modal.active { display: flex; }
    .loading-overlay { display: none; }
    .loading-overlay.active { display: flex; }
  </style>
 </head>
 <body class="bg-slate-50 text-slate-800">

  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay fixed inset-0 bg-white/80 z-[100] items-center justify-center flex-col gap-4 backdrop-blur-sm">
    <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
    <p id="loading-text" class="text-slate-600 font-bold">กำลังประมวลผล...</p>
  </div>

  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-slate-300 hidden md:flex flex-col shadow-xl">
      <div class="p-6 border-b border-slate-800 flex items-center gap-3">
        <div class="w-10 h-10 bg-orange-600 rounded-xl flex items-center justify-center text-white font-bold text-xl">X</div>
        <div>
          <h1 class="text-white font-bold">X-BUILT 99</h1>
          <p class="text-[10px] text-slate-400">Construction Management</p>
        </div>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-600 text-white shadow-lg shadow-orange-900/20">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>แผงควบคุม</span>
        </button>
        <button onclick="switchTab('customers')" id="nav-customers" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800">
          <i data-lucide="users" class="w-5 h-5"></i><span>ฐานข้อมูลลูกค้า</span>
        </button>
        <button onclick="switchTab('projects')" id="nav-projects" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800">
          <i data-lucide="hard-hat" class="w-5 h-5"></i><span>โครงการ</span>
        </button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 h-screen overflow-y-auto p-6">
      <header class="flex justify-between items-end mb-8">
        <div>
          <h2 id="page-title" class="text-3xl font-bold text-slate-800">ภาพรวมบริษัท</h2>
          <p class="text-slate-500 text-sm">ยินดีต้อนรับสู่ระบบ CRM</p>
        </div>
        <button onclick="openModal(false)" id="add-btn" class="hidden bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-orange-600 transition-all flex items-center gap-2">
          <i data-lucide="plus" class="w-5 h-5"></i> เพิ่มข้อมูล
        </button>
      </header>

      <!-- Dashboard -->
      <div id="dashboard" class="tab-content active">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-slate-500 text-sm">จำนวนโครงการ</p>
            <h3 class="text-3xl font-bold" id="dash-projects">0</h3>
          </div>
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-slate-500 text-sm">จำนวนลูกค้า</p>
            <h3 class="text-3xl font-bold" id="dash-customers">0</h3>
          </div>
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-slate-500 text-sm">มูลค่าโครงการรวม</p>
            <h3 class="text-3xl font-bold text-orange-600" id="dash-value">0</h3>
          </div>
        </div>
      </div>

      <!-- Customers -->
      <div id="customers" class="tab-content">
        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
          <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-100">
              <tr>
                <th class="p-4 font-bold">ชื่อลูกค้า/บริษัท</th>
                <th class="p-4 font-bold">การติดต่อ</th>
                <th class="p-4 font-bold">ที่อยู่</th>
                <th class="p-4 font-bold text-center">จัดการ</th>
              </tr>
            </thead>
            <tbody id="list-customers" class="divide-y divide-slate-50"></tbody>
          </table>
        </div>
      </div>

      <!-- Projects -->
      <div id="projects" class="tab-content">
        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
          <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-100">
              <tr>
                <th class="p-4 font-bold">ชื่อโครงการ</th>
                <th class="p-4 font-bold">สถานะ</th>
                <th class="p-4 font-bold text-right">มูลค่า</th>
                <th class="p-4 font-bold text-center">จัดการ</th>
              </tr>
            </thead>
            <tbody id="list-projects" class="divide-y divide-slate-50"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal fixed inset-0 bg-slate-900/50 items-center justify-center p-4 z-[90]">
    <div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 id="modal-title" class="font-bold text-lg">เพิ่มข้อมูล</h3>
        <button onclick="closeModal()" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
      </div>
      <div id="modal-body" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto"></div>
      <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 text-slate-600">ยกเลิก</button>
        <button onclick="saveData()" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold hover:bg-orange-600 transition-all">บันทึก</button>
      </div>
    </div>
  </div>

  <script>
    // URL สำหรับ Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhCjwyY0Wzx0GngrzIhw34L2vbVLmSvaQjVi9Sven8L7Z8ml_DJ5_7agN4Aq8gdSl-Iw/exec';
    
    let db = { customers: [], projects: [] };
    let currentTab = 'dashboard';
    let editingId = null;

    function showLoading(show, text = 'กำลังโหลด...') {
      const l = document.getElementById('loading');
      document.getElementById('loading-text').innerText = text;
      l.classList.toggle('active', show);
    }

    async function loadData() {
      showLoading(true, 'กำลังโหลดข้อมูลจาก Google Sheets...');
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getData`);
        const data = await res.json();
        
        db.customers = (data.customers || []).map(r => ({
          id: String(r[0]), name: String(r[1]), phone: String(r[2]), line: String(r[3]),
          email: String(r[4]), taxid: String(r[5]), address: String(r[6]), contact: String(r[7]), file: String(r[8])
        }));
        
        db.projects = (data.projects || []).map(r => ({
          id: String(r[0]), customerId: String(r[1]), name: String(r[2]), status: String(r[3]), value: parseFloat(r[4]) || 0
        }));

        render();
      } catch (e) {
        console.error(e);
      } finally {
        showLoading(false);
      }
    }

    // ฟังก์ชันส่งข้อมูลไปยัง Google Apps Script (สำคัญมาก: แก้ไขให้รับส่งข้อมูลได้แม่นยำขึ้น)
    async function apiCall(action, payload) {
        showLoading(true, 'กำลังส่งข้อมูลไปยังเซิร์ฟเวอร์...');
        try {
            // ใช้ URLSearchParams สำหรับการลบและการรับส่งข้อมูลผ่าน GET/POST
            // Google Apps Script รับ POST ในโหมด no-cors ได้ดีถ้าส่งเป็น JSON string ในเนื้อหาเดียว
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload })
            });

            // เนื่องด้วย no-cors เราจะไม่สามารถอ่าน response.json() ได้
            // จึงใช้วิธีรอ 2 วินาทีแล้วโหลดข้อมูลใหม่แทน
            setTimeout(loadData, 2000);
            return true;
        } catch (e) {
            console.error("API Error:", e);
            alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
            return false;
        } finally {
            setTimeout(() => showLoading(false), 2000);
        }
    }

    function render() {
      // Dashboard
      document.getElementById('dash-projects').innerText = db.projects.length;
      document.getElementById('dash-customers').innerText = db.customers.length;
      document.getElementById('dash-value').innerText = db.projects.reduce((s,p)=>s+p.value, 0).toLocaleString();

      // Customers
      const cList = document.getElementById('list-customers');
      cList.innerHTML = db.customers.map(c => `
        <tr class="hover:bg-slate-50">
          <td class="p-4">
            <div class="font-bold text-slate-800">${c.name}</div>
            <div class="text-xs text-slate-400">ID: ${c.id}</div>
          </td>
          <td class="p-4 text-sm">${c.phone}<br><span class="text-green-600">${c.line}</span></td>
          <td class="p-4 text-sm text-slate-500 max-w-[200px] truncate">${c.address}</td>
          <td class="p-4 text-center">
            <div class="flex justify-center gap-2">
              <button onclick="editCustomer('${c.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
              <button onclick="confirmDelete('customer', '${c.id}', '${c.name}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </td>
        </tr>
      `).join('');

      // Projects
      const pList = document.getElementById('list-projects');
      pList.innerHTML = db.projects.map(p => `
        <tr class="hover:bg-slate-50">
          <td class="p-4 font-bold text-slate-800">${p.name}</td>
          <td class="p-4 text-center"><span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">${p.status}</span></td>
          <td class="p-4 text-right font-mono font-bold">${p.value.toLocaleString()}</td>
          <td class="p-4 text-center">
            <div class="flex justify-center gap-2">
              <button onclick="editProject('${p.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
              <button onclick="confirmDelete('project', '${p.id}', '${p.name}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </td>
        </tr>
      `).join('');

      lucide.createIcons();
    }

    // --- DELETE LOGIC (หัวใจสำคัญของคำถาม) ---
    function confirmDelete(type, id, name) {
        // 1. ถามยืนยันก่อนเสมอ
        if (confirm(`⚠️ ยืนยันการลบข้อมูล?\n\nคุณกำลังจะลบ "${name}" ออกจากระบบถาวร\n(ไม่สามารถกู้คืนได้)`)) {
            
            if (type === 'customer') {
                // ตรวจสอบว่าลูกค้ามีโครงการผูกอยู่ไหม
                const hasProj = db.projects.some(p => p.customerId === id);
                if (hasProj) {
                    alert('❌ ไม่สามารถลบได้: ลูกค้ารายนี้มีโครงการค้างอยู่ในระบบ กรุณาลบโครงการออกก่อน');
                    return;
                }
                apiCall('deleteCustomer', { id: id });
            } else {
                apiCall('deleteProject', { id: id });
            }
        }
    }

    function switchTab(t) {
      currentTab = t;
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById(t).classList.add('active');
      
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-orange-600', 'text-white'));
      document.getElementById(`nav-${t}`).classList.add('bg-orange-600', 'text-white');

      document.getElementById('page-title').innerText = t === 'dashboard' ? 'ภาพรวมบริษัท' : (t === 'customers' ? 'ฐานข้อมูลลูกค้า' : 'โครงการก่อสร้าง');
      document.getElementById('add-btn').classList.toggle('hidden', t === 'dashboard');
    }

    function openModal(isEdit) {
      document.getElementById('modal').classList.add('active');
      const body = document.getElementById('modal-body');
      
      if (currentTab === 'customers') {
        const d = isEdit ? db.customers.find(c => c.id === editingId) : {};
        body.innerHTML = `
          <input id="f-name" value="${d.name||''}" placeholder="ชื่อลูกค้า/บริษัท" class="w-full p-3 border rounded-lg">
          <input id="f-phone" value="${d.phone||''}" placeholder="เบอร์โทรศัพท์" class="w-full p-3 border rounded-lg">
          <input id="f-line" value="${d.line||''}" placeholder="Line ID" class="w-full p-3 border rounded-lg">
          <textarea id="f-address" placeholder="ที่อยู่" class="w-full p-3 border rounded-lg h-24">${d.address||''}</textarea>
        `;
      } else {
        const d = isEdit ? db.projects.find(p => p.id === editingId) : {};
        body.innerHTML = `
          <input id="f-pname" value="${d.name||''}" placeholder="ชื่อโครงการ" class="w-full p-3 border rounded-lg">
          <select id="f-pcust" class="w-full p-3 border rounded-lg">
            <option value="">-- เลือกลูกค้า --</option>
            ${db.customers.map(c => `<option value="${c.id}" ${d.customerId===c.id?'selected':''}>${c.name}</option>`).join('')}
          </select>
          <input id="f-pvalue" type="number" value="${d.value||''}" placeholder="มูลค่า" class="w-full p-3 border rounded-lg">
          <select id="f-pstatus" class="w-full p-3 border rounded-lg">
            <option ${d.status==='New Lead'?'selected':''}>New Lead</option>
            <option ${d.status==='Quotation'?'selected':''}>Quotation</option>
            <option ${d.status==='Construction'?'selected':''}>Construction</option>
            <option ${d.status==='Completed'?'selected':''}>Completed</option>
          </select>
        `;
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      editingId = null;
    }

    async function saveData() {
        if (currentTab === 'customers') {
            const p = {
                id: editingId || 'C' + Date.now(),
                name: document.getElementById('f-name').value,
                phone: document.getElementById('f-phone').value,
                line: document.getElementById('f-line').value,
                address: document.getElementById('f-address').value
            };
            if (!p.name) return alert('ระบุชื่อ');
            await apiCall(editingId ? 'editCustomer' : 'addCustomer', p);
        } else {
            const p = {
                id: editingId || 'P' + Date.now(),
                customerId: document.getElementById('f-pcust').value,
                name: document.getElementById('f-pname').value,
                value: parseFloat(document.getElementById('f-pvalue').value),
                status: document.getElementById('f-pstatus').value
            };
            if (!p.name || !p.customerId) return alert('ระบุข้อมูลให้ครบ');
            await apiCall(editingId ? 'editProject' : 'addProject', p);
        }
        closeModal();
    }

    function editCustomer(id) { editingId = id; openModal(true); }
    function editProject(id) { editingId = id; openModal(true); }

    window.onload = loadData;
  </script>
 </body>
</html>
