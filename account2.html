<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X BUILTS 99 - Accounting & Tax Monthly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .nav-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-pulse { animation: pulse-slow 2s infinite; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">X BUILTS 99</h1>
                <p class="text-slate-500 text-sm font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ROI ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ Cloud Sync</p>
            </div>
            <div class="flex flex-col gap-2 items-end">
                <div id="connectionStatus" class="text-xs bg-slate-200 text-slate-600 px-4 py-1.5 rounded-full font-bold border border-slate-300">
                    ‚óè ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>
                <button onclick="fetchData()" class="text-xs bg-white border border-slate-300 hover:bg-slate-50 px-4 py-1.5 rounded-lg transition shadow-sm active:scale-95 flex items-center gap-2">
                    <span>üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud
                </button>
            </div>
        </header>

        <!-- Main Navigation -->
        <nav class="flex gap-8 mb-6 border-b border-slate-200 overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="pb-2 font-bold nav-active whitespace-nowrap transition">üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="pb-2 font-bold text-slate-400 hover:text-slate-600 whitespace-nowrap transition">üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ROI & ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button onclick="switchTab('tax')" id="tab-tax" class="pb-2 font-bold text-slate-400 hover:text-slate-600 whitespace-nowrap transition">üìë ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ</button>
        </nav>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card p-5 border-l-4 border-blue-500 stat-card">
                    <p class="text-xs text-slate-500 uppercase font-bold">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∞‡∏™‡∏°</p>
                    <h2 id="totalIncome" class="text-2xl font-bold text-blue-600">‡∏ø0.00</h2>
                </div>
                <div class="card p-5 border-l-4 border-red-500 stat-card">
                    <p class="text-xs text-slate-500 uppercase font-bold">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</p>
                    <h2 id="totalExpense" class="text-2xl font-bold text-red-600">‡∏ø0.00</h2>
                </div>
                <div class="card p-5 border-l-4 border-green-500 stat-card">
                    <p class="text-xs text-slate-500 uppercase font-bold">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <h2 id="netProfit" class="text-2xl font-bold text-green-600">‡∏ø0.00</h2>
                </div>
                <div class="card p-5 border-l-4 border-purple-500 stat-card">
                    <p class="text-xs text-slate-500 uppercase font-bold">Margin ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <h2 id="avgMargin" class="text-2xl font-bold text-purple-600">0%</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Form -->
                <div class="lg:col-span-1">
                    <div class="card p-6 sticky top-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700">‡∏•‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h3>
                            <button type="button" onclick="manageProjects()" class="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-600 hover:bg-slate-200">‚öôÔ∏è ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
                        </div>
                        <form id="accountForm" class="space-y-4">
                            <div>
                                <label class="text-xs text-slate-500 font-bold mb-1 block">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                                <select id="projectSelect" class="w-full border border-slate-300 p-2.5 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" required></select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-slate-500 font-bold mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                    <select id="type" class="w-full border border-slate-300 p-2.5 rounded-lg text-sm bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                        <option value="expense">üî¥ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                                        <option value="income">üîµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 font-bold mb-1 block">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <input id="category" type="text" placeholder="‡∏Ñ‡πà‡∏≤‡∏õ‡∏π‡∏ô, ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á..." class="w-full border border-slate-300 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 font-bold mb-1 block">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                <input id="description" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full border border-slate-300 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 font-bold mb-1 block">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ê‡∏≤‡∏ô)</label>
                                <input id="amount" type="number" step="0.01" placeholder="0.00" class="w-full border border-slate-300 p-2.5 rounded-lg font-bold text-xl text-blue-700 focus:ring-2 focus:ring-blue-500 outline-none" required oninput="calculateTax()">
                            </div>
                            <div class="bg-blue-50/50 p-4 rounded-xl space-y-3 border border-blue-100">
                                <div class="flex justify-between items-center text-sm">
                                    <label class="flex items-center gap-2 cursor-pointer font-medium text-slate-700">
                                        <input id="hasVat" type="checkbox" class="w-4 h-4 rounded border-slate-300" onchange="calculateTax()"> VAT 7%
                                    </label>
                                    <span id="displayVatText" class="font-bold text-blue-600">0.00</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <label class="font-medium text-slate-700">‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label>
                                    <select id="whtRate" class="text-xs border border-slate-300 rounded bg-white p-1 outline-none" onchange="calculateTax()">
                                        <option value="0">0%</option>
                                        <option value="1">1%</option>
                                        <option value="3">3%</option>
                                    </select>
                                </div>
                                <div class="pt-2 border-t border-blue-200 flex justify-between items-center">
                                    <span class="font-bold text-slate-800">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                                    <span id="displayNet" class="text-lg font-black text-blue-800">0.00</span>
                                </div>
                            </div>
                            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-[0.98]">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </form>
                    </div>
                </div>

                <!-- Table -->
                <div class="lg:col-span-2">
                    <div class="card h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                            <select id="projectFilter" onchange="processData(allRawData)" class="text-xs border p-2 rounded-lg bg-white shadow-sm font-bold text-blue-600">
                                <option value="all">üìÅ ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white sticky top-0 uppercase text-[10px] font-bold text-slate-400 border-b z-10">
                                    <tr>
                                        <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="p-4">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏´‡∏°‡∏ß‡∏î</th>
                                        <th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis View -->
        <div id="view-analysis" class="hidden space-y-6">
            <!-- ROI Analysis -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><span>üéØ</span> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (ROI)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] font-bold text-slate-400 uppercase">
                            <tr>
                                <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                                <th class="p-4 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th>
                                <th class="p-4 text-right text-red-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
                                <th class="p-4 text-right text-green-600">‡∏Å‡∏≥‡πÑ‡∏£</th>
                                <th class="p-4 text-center">ROI / Margin</th>
                            </tr>
                        </thead>
                        <tbody id="roiBody" class="divide-y divide-slate-100 font-medium"></tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><span>üìÖ</span> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] font-bold text-slate-400 uppercase">
                            <tr>
                                <th class="p-4">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ</th>
                                <th class="p-4 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</th>
                                <th class="p-4 text-right text-red-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</th>
                                <th class="p-4 text-right">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyBody" class="divide-y divide-slate-100 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tax View -->
        <div id="view-tax" class="hidden space-y-6">
            <!-- Cumulative Tax -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-700 mb-6 border-b pb-4">üìë ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°</h3>
                <div id="taxContent" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Monthly Tax Table -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><span>üóìÔ∏è</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] font-bold text-slate-400 uppercase">
                            <tr>
                                <th class="p-4">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ</th>
                                <th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</th>
                                <th class="p-4 text-right text-blue-600">VAT 7%</th>
                                <th class="p-4 text-right text-purple-600">WHT ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody id="taxMonthlyBody" class="divide-y divide-slate-100 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h4 class="font-bold text-lg mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h4>
            <div id="projectList" class="space-y-2 mb-6 max-h-48 overflow-y-auto"></div>
            <div class="flex gap-2">
                <input id="newProjectName" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." class="border p-2 rounded-lg text-sm flex-1 outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="addProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">+</button>
            </div>
            <button onclick="closeProjectModal()" class="w-full mt-6 py-2 bg-slate-100 rounded-lg text-slate-600 font-bold text-sm">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbxwNoDIQlJtyBm4Y8t_Ta7o7ncALFlPw61RFlEb6k8Sdsa1RM08Te4W8O1uPWnU5mrgXg/exec";
        let allRawData = [];
        let projects = JSON.parse(localStorage.getItem('xbuilts_projects_v3') || '["‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô A", "‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô B"]');

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            if(status === 'loading') {
                el.className = 'text-xs bg-yellow-50 text-yellow-600 px-4 py-1.5 rounded-full font-bold border border-yellow-200 loading-pulse';
                el.innerText = '‚óè ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            } else if(status === 'success') {
                el.className = 'text-xs bg-green-50 text-green-600 px-4 py-1.5 rounded-full font-bold border border-green-200';
                el.innerText = '‚óè ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            } else {
                el.className = 'text-xs bg-red-50 text-red-600 px-4 py-1.5 rounded-full font-bold border border-red-200';
                el.innerText = '‚óè ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
            }
        }

        async function fetchData() {
            updateConnectionStatus('loading');
            try {
                const response = await fetch(`${scriptURL}?t=${Date.now()}`);
                allRawData = await response.json();
                processData(allRawData);
                updateConnectionStatus('success');
            } catch (error) {
                updateConnectionStatus('error');
                console.error(error);
            }
        }

        function processData(rows) {
            if (!rows || rows.length < 2) {
                document.getElementById('transactionBody').innerHTML = '<tr><td colspan="3" class="p-10 text-center text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }
            
            const dataRows = rows.slice(1);
            const filter = document.getElementById('projectFilter').value;
            
            let stats = { inc: 0, exp: 0, vat: 0, wht: 0 };
            let projectMap = {}; 
            let monthlyMap = {}; 
            let taxMonthlyMap = {}; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

            const tbody = document.getElementById('transactionBody');
            tbody.innerHTML = '';

            dataRows.slice().reverse().forEach(row => {
                const [uuid, ts, type, proj, cat, desc, amt, vat, wht, net] = row;
                const dateObj = new Date(ts);
                const monthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}`;

                const netVal = parseFloat(net) || 0;
                const amtVal = parseFloat(amt) || 0;
                const vatVal = parseFloat(vat) || 0;
                const whtVal = parseFloat(wht) || 0;

                // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Cash Flow)
                if(!monthlyMap[monthKey]) monthlyMap[monthKey] = { inc: 0, exp: 0 };
                if(type === 'income') monthlyMap[monthKey].inc += netVal; else monthlyMap[monthKey].exp += netVal;

                // ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (VAT & WHT)
                if(!taxMonthlyMap[monthKey]) taxMonthlyMap[monthKey] = { base: 0, vat: 0, wht: 0 };
                if(type === 'expense') {
                    taxMonthlyMap[monthKey].base += amtVal;
                    taxMonthlyMap[monthKey].vat += vatVal;
                    taxMonthlyMap[monthKey].wht += whtVal;
                }

                // ROI Map
                if(!projectMap[proj]) projectMap[proj] = { inc: 0, exp: 0 };
                if(type === 'income') projectMap[proj].inc += netVal; else projectMap[proj].exp += netVal;

                // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                if(filter === 'all' || proj === filter) {
                    if(type === 'income') stats.inc += netVal; else stats.exp += netVal;
                    stats.vat += vatVal;
                    stats.wht += whtVal;

                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                            <td class="p-4 text-[10px] text-slate-400 leading-tight">
                                ${dateObj.toLocaleDateString('th-TH')}<br>${dateObj.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-slate-700 truncate max-w-[120px]">${proj}</div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase">${cat}</div>
                            </td>
                            <td class="p-4 text-right">
                                <div class="font-bold ${type === 'income'?'text-blue-600':'text-red-500'}">
                                    ${type === 'income'?'+':'-'} ‡∏ø${netVal.toLocaleString(undefined, {minimumFractionDigits:2})}
                                </div>
                                ${vatVal > 0 ? `<div class="text-[9px] text-purple-400">VAT ‡∏ø${vatVal.toFixed(2)}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }
            });

            document.getElementById('totalIncome').innerText = '‡∏ø'+stats.inc.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('totalExpense').innerText = '‡∏ø'+stats.exp.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('netProfit').innerText = '‡∏ø'+(stats.inc - stats.exp).toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('avgMargin').innerText = stats.inc > 0 ? (((stats.inc - stats.exp)/stats.inc)*100).toFixed(1) + '%' : '0%';

            renderROI(projectMap);
            renderMonthly(monthlyMap);
            renderTax(stats);
            renderTaxMonthly(taxMonthlyMap);
        }

        function renderROI(map) {
            const body = document.getElementById('roiBody');
            body.innerHTML = '';
            Object.entries(map).sort((a,b) => b[1].inc - a[1].inc).forEach(([name, data]) => {
                const profit = data.inc - data.exp;
                const roi = data.exp > 0 ? (profit / data.exp * 100) : 0;
                const margin = data.inc > 0 ? (profit / data.inc * 100) : 0;
                body.innerHTML += `
                    <tr>
                        <td class="p-4 font-bold text-slate-700">${name}</td>
                        <td class="p-4 text-right">‡∏ø${data.inc.toLocaleString()}</td>
                        <td class="p-4 text-right text-red-400">‡∏ø${data.exp.toLocaleString()}</td>
                        <td class="p-4 text-right ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">‡∏ø${profit.toLocaleString()}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded-full text-[10px] ${margin >= 20 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ROI: ${roi.toFixed(1)}% / Margin: ${margin.toFixed(1)}%
                            </span>
                        </td>
                    </tr>
                `;
            });
        }

        function renderMonthly(map) {
            const body = document.getElementById('monthlyBody');
            body.innerHTML = '';
            Object.entries(map).sort((a,b) => b[0].localeCompare(a[0])).forEach(([key, data]) => {
                const diff = data.inc - data.exp;
                const [y, m] = key.split('-');
                const monthName = new Date(y, m-1).toLocaleDateString('th-TH', {month:'long', year:'numeric'});
                body.innerHTML += `
                    <tr>
                        <td class="p-4 text-slate-600">${monthName}</td>
                        <td class="p-4 text-right text-blue-600">‡∏ø${data.inc.toLocaleString()}</td>
                        <td class="p-4 text-right text-red-400">‡∏ø${data.exp.toLocaleString()}</td>
                        <td class="p-4 text-right font-bold ${diff >= 0 ? 'text-slate-700' : 'text-red-600'}">‡∏ø${diff.toLocaleString()}</td>
                    </tr>
                `;
            });
        }

        function renderTaxMonthly(map) {
            const body = document.getElementById('taxMonthlyBody');
            body.innerHTML = '';
            Object.entries(map).sort((a,b) => b[0].localeCompare(a[0])).forEach(([key, data]) => {
                const [y, m] = key.split('-');
                const monthName = new Date(y, m-1).toLocaleDateString('th-TH', {month:'long', year:'numeric'});
                body.innerHTML += `
                    <tr class="border-b border-slate-50">
                        <td class="p-4 text-slate-700 font-bold">${monthName}</td>
                        <td class="p-4 text-right text-slate-500 font-medium">‡∏ø${data.base.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                        <td class="p-4 text-right text-blue-600 font-bold">‡∏ø${data.vat.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                        <td class="p-4 text-right text-purple-600 font-bold">‡∏ø${data.wht.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    </tr>
                `;
            });
        }

        function renderTax(stats) {
            const content = document.getElementById('taxContent');
            content.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <h4 class="text-blue-800 font-bold mb-2">üõçÔ∏è ‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏∞‡∏™‡∏° (VAT)</h4>
                    <p class="text-2xl font-black text-blue-700">‡∏ø${stats.vat.toLocaleString(undefined, {minimumFractionDigits:2})}</p>
                </div>
                <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                    <h4 class="text-purple-800 font-bold mb-2">‚úÇÔ∏è ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏° (WHT)</h4>
                    <p class="text-2xl font-black text-purple-700">‡∏ø${stats.wht.toLocaleString(undefined, {minimumFractionDigits:2})}</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h4 class="text-slate-800 font-bold mb-2">üìà ‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ (‡∏ô‡∏¥‡∏ï‡∏¥‡∏Ø)</h4>
                    <p class="text-xl font-bold text-slate-600">‡∏ø${(stats.exp * 0.2).toLocaleString(undefined, {minimumFractionDigits:0})}</p>
                    <p class="text-[10px] text-slate-400 italic">* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ê‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ 20%</p>
                </div>
            `;
        }

        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = '‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            
            const tax = calculateTax();
            const payload = {
                type: document.getElementById('type').value,
                project: document.getElementById('projectSelect').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                amount: tax.amount,
                vat: tax.vat,
                wht: tax.wht,
                net: tax.net
            };

            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                document.getElementById('accountForm').reset();
                calculateTax();
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                setTimeout(fetchData, 1000); 
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        });

        function calculateTax() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const hasVat = document.getElementById('hasVat').checked;
            const whtRate = parseFloat(document.getElementById('whtRate').value) || 0;
            const vat = hasVat ? amount * 0.07 : 0;
            const wht = amount * (whtRate / 100);
            const net = amount + vat - wht;
            document.getElementById('displayVatText').innerText = vat.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('displayNet').innerText = net.toLocaleString(undefined, {minimumFractionDigits:2});
            return { amount, vat, wht, net };
        }

        function switchTab(tab) {
            ['dashboard', 'analysis', 'tax'].forEach(t => {
                document.getElementById('view-' + t).classList.toggle('hidden', t !== tab);
                document.getElementById('tab-' + t).className = t === tab 
                    ? 'pb-2 font-bold nav-active whitespace-nowrap transition' 
                    : 'pb-2 font-bold text-slate-400 hover:text-slate-600 whitespace-nowrap transition';
            });
        }

        function updateProjectOptions() {
            const sels = ['projectSelect', 'projectFilter'];
            sels.forEach(id => {
                const el = document.getElementById(id);
                const currentVal = el.value;
                el.innerHTML = id === 'projectFilter' ? '<option value="all">üìÅ ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>' : '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --</option>';
                projects.sort().forEach(p => el.innerHTML += `<option value="${p}">${p}</option>`);
                el.value = currentVal;
            });
        }

        function manageProjects() {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            projects.forEach((p, index) => {
                list.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="text-sm font-medium text-slate-700">${p}</span><button onclick="removeProject(${index})" class="text-red-400 hover:text-red-600 px-2">‡∏•‡∏ö</button></div>`;
            });
            document.getElementById('projectModal').classList.remove('hidden');
        }

        function addProject() {
            const name = document.getElementById('newProjectName').value.trim();
            if (name && !projects.includes(name)) {
                projects.push(name);
                localStorage.setItem('xbuilts_projects_v3', JSON.stringify(projects));
                document.getElementById('newProjectName').value = '';
                updateProjectOptions();
                manageProjects();
            }
        }

        function removeProject(index) {
            if(confirm('‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£?')) {
                projects.splice(index, 1);
                localStorage.setItem('xbuilts_projects_v3', JSON.stringify(projects));
                updateProjectOptions();
                manageProjects();
            }
        }

        function closeProjectModal() { document.getElementById('projectModal').classList.add('hidden'); }

        window.onload = () => {
            updateProjectOptions();
            fetchData();
        };
    </script>
</body>
</html>
