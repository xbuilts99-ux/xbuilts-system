<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X BUILTS 99 - Accounting & Tax Monthly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .nav-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-[100]">
        <div class="card p-8 max-w-sm w-full mx-4 shadow-2xl border-t-4 border-blue-600">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">X BUILTS 99</h1>
                <p class="text-slate-500 text-sm mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Username</label>
                    <input type="text" id="username" class="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" required autocomplete="username">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Password</label>
                    <input type="password" id="password" class="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" required autocomplete="current-password">
                </div>
                <div id="loginError" class="hidden text-red-500 text-xs font-bold text-center bg-red-50 py-2 rounded-lg">‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <!-- Application Dashboard (Main) -->
    <div id="mainApp" class="max-w-7xl mx-auto hidden">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">X BUILTS 99</h1>
                <p class="text-slate-500 text-sm font-medium">Accounting & Tax ROI Analysis</p>
            </div>
            <div class="flex flex-col gap-2 items-end">
                <div id="connectionStatus" class="text-xs bg-slate-200 text-slate-600 px-4 py-1.5 rounded-full font-bold border border-slate-300">
                    ‚óè ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>
                <div class="flex gap-2">
                    <button onclick="fetchData()" class="text-xs bg-white border border-slate-300 hover:bg-slate-50 px-4 py-1.5 rounded-lg transition active:scale-95">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    <button onclick="logout()" class="text-xs bg-red-50 text-red-600 border border-red-100 px-4 py-1.5 rounded-lg hover:bg-red-100 transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </header>

        <nav class="flex gap-8 mb-6 border-b border-slate-200 overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="pb-2 font-bold nav-active whitespace-nowrap transition">üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="pb-2 font-bold text-slate-400 hover:text-slate-600 whitespace-nowrap transition">üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ROI</button>
            <button onclick="switchTab('tax')" id="tab-tax" class="pb-2 font-bold text-slate-400 hover:text-slate-600 whitespace-nowrap transition">üìë ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ</button>
        </nav>

        <div id="view-dashboard" class="space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="statsRow">
                <div class="card p-5 border-l-4 border-blue-500"><p class="text-xs text-slate-500 font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∞‡∏™‡∏°</p><h2 id="totalIncome" class="text-2xl font-bold text-blue-600">‡∏ø0.00</h2></div>
                <div class="card p-5 border-l-4 border-red-500"><p class="text-xs text-slate-500 font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</p><h2 id="totalExpense" class="text-2xl font-bold text-red-600">‡∏ø0.00</h2></div>
                <div class="card p-5 border-l-4 border-green-500"><p class="text-xs text-slate-500 font-bold uppercase">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p><h2 id="netProfit" class="text-2xl font-bold text-green-600">‡∏ø0.00</h2></div>
                <div class="card p-5 border-l-4 border-purple-500"><p class="text-xs text-slate-500 font-bold uppercase">Margin</p><h2 id="avgMargin" class="text-2xl font-bold text-purple-600">0%</h2></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="card p-6 sticky top-6">
                        <h3 class="font-bold text-slate-700 mb-4 flex justify-between items-center">‡∏•‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà <button onclick="manageProjects()" class="text-[10px] bg-slate-100 px-2 py-1 rounded">‚öôÔ∏è ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button></h3>
                        <form id="accountForm" class="space-y-4">
                            <select id="projectSelect" class="w-full border border-slate-300 p-2.5 rounded-lg text-sm" required></select>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="type" class="border border-slate-300 p-2.5 rounded-lg text-sm bg-slate-50">
                                    <option value="expense">üî¥ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                                    <option value="income">üîµ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                                </select>
                                <input id="category" type="text" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" class="border border-slate-300 p-2.5 rounded-lg text-sm" required>
                            </div>
                            <input id="amount" type="number" step="0.01" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="w-full border border-slate-300 p-3 rounded-lg font-bold text-xl text-blue-700" required oninput="calculateTax()">
                            <div class="bg-blue-50 p-4 rounded-xl text-sm space-y-2">
                                <label class="flex justify-between items-center cursor-pointer">
                                    <span>VAT 7%</span><input id="hasVat" type="checkbox" onchange="calculateTax()" class="w-4 h-4">
                                </label>
                                <div class="flex justify-between items-center">
                                    <span>‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</span>
                                    <select id="whtRate" onchange="calculateTax()" class="border rounded px-1"><option value="0">0%</option><option value="1">1%</option><option value="3">3%</option></select>
                                </div>
                                <div class="pt-2 border-t border-blue-200 flex justify-between font-bold">
                                    <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span><span id="displayNet" class="text-blue-800">0.00</span>
                                </div>
                            </div>
                            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="card overflow-hidden">
                        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                            <select id="projectFilter" onchange="processData(allRawData)" class="text-xs border p-2 rounded-lg font-bold text-blue-600"></select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white uppercase text-[10px] font-bold text-slate-400 border-b">
                                    <tr><th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th></tr>
                                </thead>
                                <tbody id="transactionBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-analysis" class="hidden space-y-6">
            <div class="card p-6"><h3 class="font-bold text-slate-700 mb-4">üéØ ‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3><table class="w-full"><tbody id="roiBody" class="text-sm"></tbody></table></div>
            <div class="card p-6"><h3 class="font-bold text-slate-700 mb-4">üìÖ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3><table class="w-full"><tbody id="monthlyBody" class="text-sm"></tbody></table></div>
        </div>

        <div id="view-tax" class="hidden space-y-6">
            <div id="taxSummary" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div class="card p-6"><h3 class="font-bold text-slate-700 mb-4">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (VAT/WHT)</h3><table class="w-full"><tbody id="taxMonthlyBody" class="text-sm"></tbody></table></div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
            <h4 class="font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h4>
            <div id="projectList" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
            <div class="flex gap-2">
                <input id="newProjectName" type="text" class="border p-2 rounded flex-1 text-sm outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£">
                <button onclick="addProject()" class="bg-blue-600 text-white px-4 rounded font-bold">+</button>
            </div>
            <button onclick="closeProjectModal()" class="w-full mt-4 py-2 bg-slate-100 rounded font-bold">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script>
        /**
         * AUTH v4 - Reliable Check
         * Username: xbuilts
         * Password: Thoon5247%
         */
        const _v1 = "eGJ1aWx0cw=="; // b64 xbuilts
        const _v2 = "VGhvb241MjQ3JQ=="; // b64 Thoon5247%

        function checkAuth(u, p) {
            try {
                // ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Username
                const cleanU = u.trim().toLowerCase();
                const cleanP = p.trim();
                return atob(_v1) === cleanU && atob(_v2) === cleanP;
            } catch(e) { return false; }
        }

        const scriptURL = "https://script.google.com/macros/s/AKfycbxwNoDIQlJtyBm4Y8t_Ta7o7ncALFlPw61RFlEb6k8Sdsa1RM08Te4W8O1uPWnU5mrgXg/exec";
        const SESSION_KEY = 'xb_login_status';
        let allRawData = [];
        let projects = JSON.parse(localStorage.getItem('xb_projects_v4') || '["‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ A", "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ B"]');

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            
            btn.innerText = "Checking...";
            btn.disabled = true;
            err.classList.add('hidden');

            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            if (checkAuth(u, p)) {
                localStorage.setItem(SESSION_KEY, 'verified');
                initApp();
            } else {
                err.classList.remove('hidden');
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                btn.disabled = false;
            }
        });

        function initApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
            updateProjectOptions();
            fetchData();
        }

        function logout() {
            localStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        async function fetchData() {
            const status = document.getElementById('connectionStatus');
            status.innerText = "‚óè ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            status.className = "text-xs bg-yellow-50 text-yellow-600 px-4 py-1.5 rounded-full font-bold loading-pulse";
            try {
                const res = await fetch(`${scriptURL}?t=${Date.now()}`);
                allRawData = await res.json();
                processData(allRawData);
                status.innerText = "‚óè ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                status.className = "text-xs bg-green-50 text-green-600 px-4 py-1.5 rounded-full font-bold border border-green-200";
            } catch (e) {
                status.innerText = "‚óè ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
                status.className = "text-xs bg-red-50 text-red-600 px-4 py-1.5 rounded-full font-bold border border-red-200";
            }
        }

        function processData(rows) {
            if (!rows || rows.length < 2) return;
            const data = rows.slice(1);
            const filter = document.getElementById('projectFilter').value;
            let s = { inc: 0, exp: 0, vat: 0, wht: 0 };
            let pMap = {}, mMap = {}, tMap = {};
            
            const tbody = document.getElementById('transactionBody');
            tbody.innerHTML = '';

            data.slice().reverse().forEach(row => {
                const [id, ts, type, proj, cat, desc, amt, vat, wht, net] = row;
                const n = parseFloat(net) || 0;
                const a = parseFloat(amt) || 0;
                const v = parseFloat(vat) || 0;
                const w = parseFloat(wht) || 0;
                const d = new Date(ts);
                const mKey = d.toLocaleDateString('th-TH', {month:'short', year:'2-digit'});

                if(!pMap[proj]) pMap[proj] = { inc: 0, exp: 0 };
                if(type === 'income') pMap[proj].inc += n; else pMap[proj].exp += n;

                if(!mMap[mKey]) mMap[mKey] = { inc: 0, exp: 0 };
                if(type === 'income') mMap[mKey].inc += n; else mMap[mKey].exp += n;

                if(!tMap[mKey]) tMap[mKey] = { base: 0, vat: 0, wht: 0 };
                if(type === 'expense') { tMap[mKey].base += a; tMap[mKey].vat += v; tMap[mKey].wht += w; }

                if(filter === 'all' || proj === filter) {
                    if(type === 'income') s.inc += n; else s.exp += n;
                    s.vat += v; s.wht += w;
                    tbody.innerHTML += `<tr class="border-b"><td class="p-4 text-[10px] text-slate-400">${d.toLocaleDateString('th-TH')}</td><td class="p-4"><div class="font-bold">${proj}</div><div class="text-[10px] text-slate-400 uppercase">${cat}</div></td><td class="p-4 text-right font-bold ${type==='income'?'text-blue-600':'text-red-500'}">‡∏ø${n.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>`;
                }
            });

            document.getElementById('totalIncome').innerText = '‡∏ø'+s.inc.toLocaleString();
            document.getElementById('totalExpense').innerText = '‡∏ø'+s.exp.toLocaleString();
            document.getElementById('netProfit').innerText = '‡∏ø'+(s.inc-s.exp).toLocaleString();
            document.getElementById('avgMargin').innerText = s.inc > 0 ? (((s.inc-s.exp)/s.inc)*100).toFixed(1)+'%' : '0%';

            renderROI(pMap);
            renderMonthly(mMap);
            renderTax(s, tMap);
        }

        function renderROI(map) {
            const b = document.getElementById('roiBody'); b.innerHTML = '';
            Object.entries(map).sort((a,b)=>b[1].inc-a[1].inc).forEach(([n, d]) => {
                const profit = d.inc-d.exp;
                b.innerHTML += `<tr class="border-b"><td class="p-3 font-bold">${n}</td><td class="p-3 text-right text-blue-600">‡∏ø${d.inc.toLocaleString()}</td><td class="p-3 text-right text-red-400">‡∏ø${d.exp.toLocaleString()}</td><td class="p-3 text-right font-bold">‡∏ø${profit.toLocaleString()}</td></tr>`;
            });
        }

        function renderMonthly(map) {
            const b = document.getElementById('monthlyBody'); b.innerHTML = '';
            Object.entries(map).reverse().forEach(([k, d]) => {
                b.innerHTML += `<tr class="border-b"><td class="p-3 font-medium">${k}</td><td class="p-3 text-right text-blue-600">‡∏ø${d.inc.toLocaleString()}</td><td class="p-3 text-right text-red-400">‡∏ø${d.exp.toLocaleString()}</td><td class="p-3 text-right font-bold">‡∏ø${(d.inc-d.exp).toLocaleString()}</td></tr>`;
            });
        }

        function renderTax(s, tMap) {
            document.getElementById('taxSummary').innerHTML = `<div class="card p-4 bg-blue-50">VAT ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏∞‡∏™‡∏°: <span class="font-bold text-blue-700">‡∏ø${s.vat.toLocaleString()}</span></div><div class="card p-4 bg-purple-50">WHT ‡∏´‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°: <span class="font-bold text-purple-700">‡∏ø${s.wht.toLocaleString()}</span></div>`;
            const b = document.getElementById('taxMonthlyBody'); b.innerHTML = '';
            Object.entries(tMap).reverse().forEach(([k, d]) => {
                b.innerHTML += `<tr class="border-b"><td class="p-3 font-bold">${k}</td><td class="p-3 text-right">‡∏ø${d.base.toLocaleString()}</td><td class="p-3 text-right text-blue-600">‡∏ø${d.vat.toLocaleString()}</td><td class="p-3 text-right text-purple-600">‡∏ø${d.wht.toLocaleString()}</td></tr>`;
            });
        }

        function calculateTax() {
            const a = parseFloat(document.getElementById('amount').value) || 0;
            const v = document.getElementById('hasVat').checked ? a * 0.07 : 0;
            const w = a * (parseFloat(document.getElementById('whtRate').value)/100);
            const net = a + v - w;
            document.getElementById('displayNet').innerText = net.toLocaleString(undefined,{minimumFractionDigits:2});
            return { a, v, w, net };
        }

        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            const t = calculateTax();
            const payload = {
                type: document.getElementById('type').value,
                project: document.getElementById('projectSelect').value,
                category: document.getElementById('category').value,
                amount: t.a, vat: t.v, wht: t.w, net: t.net
            };
            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                document.getElementById('accountForm').reset();
                calculateTax();
                setTimeout(fetchData, 1500);
            } finally { btn.disabled = false; btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; }
        });

        function switchTab(t) {
            ['dashboard','analysis','tax'].forEach(v => {
                document.getElementById('view-'+v).classList.toggle('hidden', v!==t);
                document.getElementById('tab-'+v).className = v===t ? 'pb-2 font-bold nav-active whitespace-nowrap transition' : 'pb-2 font-bold text-slate-400 whitespace-nowrap transition';
            });
        }

        function updateProjectOptions() {
            ['projectSelect', 'projectFilter'].forEach(id => {
                const el = document.getElementById(id);
                el.innerHTML = id === 'projectFilter' ? '<option value="all">üìÅ ‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>' : '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --</option>';
                projects.forEach(p => el.innerHTML += `<option value="${p}">${p}</option>`);
            });
        }

        function manageProjects() {
            const l = document.getElementById('projectList'); l.innerHTML = '';
            projects.forEach((p, i) => l.innerHTML += `<div class="flex justify-between p-2 bg-slate-50 rounded text-sm"><span>${p}</span><button onclick="removeProject(${i})" class="text-red-400">‡∏•‡∏ö</button></div>`);
            document.getElementById('projectModal').classList.remove('hidden');
        }

        function addProject() {
            const n = document.getElementById('newProjectName').value.trim();
            if(n && !projects.includes(n)) { projects.push(n); localStorage.setItem('xb_projects_v4', JSON.stringify(projects)); updateProjectOptions(); manageProjects(); }
        }

        function removeProject(i) { projects.splice(i,1); localStorage.setItem('xb_projects_v4', JSON.stringify(projects)); updateProjectOptions(); manageProjects(); }
        function closeProjectModal() { document.getElementById('projectModal').classList.add('hidden'); }

        window.onload = () => {
            if(localStorage.getItem(SESSION_KEY) === 'verified') {
                initApp();
            }
        };
    </script>
</body>
</html>
